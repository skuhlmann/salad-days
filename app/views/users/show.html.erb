<%= render partial: "partials/profile_header", locals: {:user => @user} %>

<div class="column-group">
  <% if @user.market.blank? %>
    <div class="all-75">
      <p class="medium-content">You haven't opened a market yet.</p>
      <p><%= link_to "Create a Market", new_market_path(@user.id), class: "listing-btn" %></p>
    </div>
  <% else %>
  <div class="all-60">
    <div id="user-market">
      <div class="column-group">
        <div class="all-70">
          <h3><%= @user.market.name.titleize %> <span class="edit-link"><%= link_to "Edit your market", edit_market_path(@user.market.slug), class: "small"  %></span></h3>
          <p class="small">Email</p>
          <p class="medium-content"><%= @user.market.email %></p>
          <p class="small">Address</p>
          <p class="medium-content"><%= @user.market.full_address %></p>
          <p class="small">Products</p>
          <p class="medium-content"><%= @user.market.products %></p>
        </div>
        <div class="all-30">
          <%= image_tag @user.market.image.url %>
        </div>
      </div>
      <% unless @user.market.listings.empty? %>
        <div id="listing-grid">
          <h4>Current Listings <span class="edit-link"><%= link_to "Add a listing", new_market_listing_path(@user.market.slug), class: "small"  %></span></h4>
          <table class="ink-table">
            <thead>
              <tr>
                <th class="align-left"></th>
                <th class="align-left">Name</th>
                <th class="align-left">Description</th>
                <th class="align-left">Harvest Date</th>
                <th class="align-left"></th>
                <th class="align-left"></th>
              </tr>
            </thead>
            <tbody>
            <% @user.market.listings.active.each do |listing| %>
            <tr>
              <td><%= image_tag listing.image.url(:thumb) %></td>
              <td><%= listing.name %></td>
              <td><%= listing.description %></td>
              <td><%= listing.harvest_date %></td>
              <td><%= link_to "Edit listing", edit_market_listing_path(@user.market.slug, listing.id), class: "edit-link" %><br>
                <%= link_to "Sold/Remove", market_listing_path(@user.market.slug, listing.id, listing: {active: false}), method: "put", class: "edit-link" %></td>
              <td>
                <%= form_tag tweet_path, method: :get do %>
                  <%= hidden_field_tag :listing_id, listing.id %>
                  <%= submit_tag "Tweet me", class: "listing-btn" %>
                <% end %>
              </td>
            </tr>
            <% end %>
            </tbody>
          </table>
        </div>
    <% else %>
      <%= link_to "Add a listing", new_market_listing_path(@user.market.slug), class: "listing-btn" %>
    <% end %>
    </div>
  </div>

   <% end %>

  <div class="all-40">
    <div id="user-info">
      <p class="small">Twitter Account ID</p>
      <p class="medium-content"><%= @user.uid %></p>
      <p class="small">Twitter Account Location</p>
      <p class="medium-content"><%= @user.location %></p>
      <p class="small">Twitter Account Description</p>
      <p class="medium-content"><%= @user.description %></p>
    </div>

    <% unless @user.flagged_markets.empty? %>
      <div>
        <h4>Flagged market activity</h5>
        <% @user.flagged_markets.each do |market| %>
          <p class="small"><%= market.name %></p>
          <p class="small"><%= link_to "View more details", market_path(market.slug) %></p>
          <% market.listings.each do |listing| %>
            <p class="small"><%= image_tag listing.image.url(:thumb) %> <%= listing.name %></p>
          <% end %>
            <%= form_tag flag_path, method: "delete" do %>
              <%= hidden_field_tag :market_id, market.id %>
              <%= hidden_field_tag :user_id, @user.id %>
              <%= submit_tag "Unflag It", class: "listing-btn" %>
            <% end %>
        <% end %>
      </div>
    <% end %>

  </div>
</div>

<% if @user.market.blank? %>
  <div class="spacer">
  </div>
<% end %>
